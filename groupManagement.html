<html>
<head>
  <title>Title of the document</title>
</head>

<body>
  <!-- Create group: Button and text field for name. -->
  Create Group:
  <div>
    <input type="button" value="Create " onclick="createGroup();"/>
    Group Name: <input type="text" id="create-group-name"/>
  </div>

  <!-- Update group: Button and text fields for id and name. -->
  Update Group:
  <div>
    <input type="button" value="Update" onclick="updateGroup();"/>
    Group ID: <input type="text" id="update-group-id"/>
    Group Name: <input type="text" id="update-group-name"/>
  </div>

  <!-- Delete group: Button and text field for id. -->
  Delete Group:
  <div>
    <input type="button" value="Delete" onclick="deleteGroup();"/>
    Group ID: <input type="text" id="delete-group-id"/>
  </div>

  <!-- Add to group: Button and text fields for id and members. -->
  Add to Group:
  <div>
    <input type="button" value="Add to Group" onclick="addMembers();"/>
    Group ID: <input type="text" id="add-group-id"/>
    Users: <input type="text" id="add-members"/>
  </div>

  <!-- Remove from group: Button and text fields for id and members. -->
  Remove from Group:
  <div>
    <input type="button" value="Remove from Group" onclick="removeMembers();"/>
    Group ID: <input type="text" id="remove-group-id"/>
    Users: <input type="text" id="remove-members"/>
  </div>

  <!-- Get group list: Button. -->
  Get groups:
  <div>
    <input type="button" value="Get Groups" onclick="getGroups();"/>
  </div>

  <!-- Get group info: Button abd text field for id. -->
  Get Group Info:
  <div>
    <input type="button" value="Get Group Info" onclick="getInfo();"/>
    Group ID: <input type="text" id="info-group-id"/>
  </div>

  <!-- Application log. -->
  <div id="log"> Log: </div>

  <!-- Group retrieval. -->
  <div id="group-info"> Group Info: </div>

  <!-- Group messaging: Button and text fields for id and message. -->
  Chat:
  <div>
    Group ID: <input type="text" id="chat-group-id"/>
    Message: <input type="text" id="chat-message"/>
    <input type="button" value="Send" onclick="sendMessage();"/>

    <div id="chat-messages"></div>
  </div>

  <script>
  /**
  * Kandy.io Group Demo
  * View this tutorial and others at https://developer.kandy.io/tutorials
  */

  // Variables for logging in.
  var projectAPIKey = "DAKc67cc9a3927142dd88af8a93cc79e0a2";
  var username = "gituser1";
  var password = "fakepword123";

  kandy.login(projectAPIKey, username, password, onLoginSuccess, onLoginFailure);

  // What to do on a successful login.
  function onLoginSuccess() {
    log("Login was successful.");
  }

  // What to do on a failed login.
  function onLoginFailure() {
    log("Login failed. Make sure you input the user's credentials!");
  }

  // Utility function for appending messages to the message div.
  function log(message) {
    document.getElementById("log").innerHTML += "<div>" + message + "</div>";
  }

  // Configure Kandy for group chat.
  kandy.setup({
    // Register listeners to group chat events.
    listeners: {
      chatGroupMessage: onChatGroupMessage,
      chatGroupInvite: onChatGroupInvite,
      chatGroupBoot: onChatGroupBoot,
      chatGroupUpdate: onChatGroupUpdate,
      chatGroupDelete: onChatGroupDelete
    }
  });

  // Gather the user's input then creates a group.
  function createGroup() {
    var name = document.getElementById("create-group-name").value;

    // Tell Kandy to create the group.
    kandy.messaging.createGroup(name, null, onCreateSuccess, onCreateFailure);
  }

  // What to do on a create group success.
  function onCreateSuccess(group) {
    log("Group created: " + group.group_name + " (" + group.group_id + ").");
  }

  // What to do on a create group failure.
  function onCreateFailure() {
    log("Failed to create group.");
  }

  // Gather the user's input then update the specified group.
  function updateGroup() {
    var id = document.getElementById("update-group-id").value;
    var name = document.getElementById("update-group-name").value;

    // Tell Kandy to update the group.
    kandy.messaging.updateGroup(id, name, null, onUpdateSuccess, onUpdateFailure);
  }

  // What to do on an update group success.
  function onUpdateSuccess(group) {
    log("Group updated: " + group.group_name + " (" + group.group_id + ").");
  }

  // What to do on an update group failure.
  function onUpdateFailure() {
    log("Failed to update group.");
  }

  // Gather the user's input then delete the specified group.
  function deleteGroup() {
    var id = document.getElementById("delete-group-id").value;

    // Tell Kandy to delete the group.
    kandy.messaging.deleteGroup(id, onDeleteSuccess, onDeleteFailure);
  }

  // What to do on a delete group success.
  function onDeleteSuccess() {
    log("Group deleted.");
  }

  // What to do on a delete group failure.
  function onDeleteFailure() {
    log("Failed to delete group.");
  }

  // Gather the user's input then join the specified group.
  function addMembers() {
    var id = document.getElementById("add-group-id").value;
    var users = document.getElementById("add-members").value;

    // Kandy expects users as an array.
    users = users.split(", ");

    // Tell Kandy to add the users to the group.
    kandy.messaging.addGroupMembers(id, users, onAddSuccess, onAddFailure);
  }

  // What to do on an add member success.
  function onAddSuccess(group) {
    log("Members added to group.");
    log(JSON.stringify(group));
  }

  // What to do on an add member failure.
  function onAddFailure() {
    log("Failed to add members to group.");
  }

  // Gather the user's input then remove the specified members from the group.
  function removeMembers() {
    var id = document.getElementById("remove-group-id").value;
    var users = document.getElementById("remove-members").value;

    // Kandy expects users as an array.
    users = users.split(", ");

    // Tell Kandy to remove the users from the group.
    kandy.messaging.removeGroupMembers(id, users, onRemoveSuccess, onRemoveFailure);
  }

  // What to do on a remove member success.
  function onRemoveSuccess(group) {
    log("Members removed from group.");
  }

  // What to do on a remove member failure.
  function onRemoveFailure() {
    log("Failed to remove members from group.");
  }

  // Gather the user's input then send a message to the group.
  function sendMessage() {
    var id = document.getElementById("chat-group-id").value;
    var message = document.getElementById("chat-message").value;

    // Tell Kandy to send the message to the group.
    kandy.messaging.sendGroupIm(id, message, onSendSuccess, onSendFailure);
  }

  // What to do on an send message success.
  function onSendSuccess(message) {
    // Handle the message.
    var id = message.group_id;
    var messageText = message.message.text;
    // Create the message element. Use Lodash to escape the message to prevent security issues.
    var element = "<div>Me (" + id + "): " + _.escape(messageText) + "</div>";

    // Add the message to the chat messages div.
    document.getElementById("chat-messages").innerHTML += element;
  }

  // What to do on a send message failure.
  function onSendFailure() {
    log("Failed to send group message.");
  }

  // Get groups the user is a member of.
  function getGroups() {
    // Tell Kandy to get groups.
    kandy.messaging.getGroups(onGetGroupsSuccess, onGetGroupsFailure);
  }

  // What to do on a get groups success.
  function onGetGroupsSuccess(result) {
    // Get the element we'll be displaying groups in.
    var groupElement = document.getElementById("group-info");
    // Clear any current info in the element and start a new list.
    groupElement.innerHTML = "Groups: <ul>";

    // Iterate over the groups and display basic info about them.
    result.groups.forEach( function(group) {
      var id = group.group_id;
      var name = group.group_name;
      var memberCount = group.owners.length + group.members.length;

      var element = "<li>Group ID: " + id + ". Name: " + name + ". Members: " + memberCount + ".</li>";
      groupElement.innerHTML += element;
    });
    // Close the list.
    groupElement.innerHTML += "</ul>";
  }

  // What to do on a get groups failure.
  function onGetGroupsFailure() {
    log("Failed to get groups.");
  }

  // Gather the user's input then get the specified group.
  function getInfo() {
    var id = document.getElementById("info-group-id").value;

    // Tell Kandy to get the group.
    kandy.messaging.getGroupById(id, onGetInfoSuccess, onGetInfoFailure);
  }

  // What to do on a get info success.
  function onGetInfoSuccess(group) {
    var groupElement = document.getElementById("group-info");

    // Get the element we'll be displaying groups in.
    var groupElement = document.getElementById("group-info");
    // Clear any current info in the element.
    groupElement.innerHTML = "Group Info:";

    // Create an element for group information.
    var groupInfoElement = "<ul>" +
    "<li>Group ID: " + group.group_id + "</li>" +
    "<li>Name: " + group.group_name + "</li>" +
    "<li>Muted: " + group.muted + "</li>" +
    "<li>Owner: " + group.owners[0].full_user_id + "</li>" +
    "<li>Members: <ul>";

    if(group.members) {
      group.members.forEach(function(member) {
        groupInfoElement += "<li>" + member.full_user_id + "</li>";
      });
    }
    groupInfoElement += "</ul></ul>";

    // Output the group information to the group element.
    groupElement.innerHTML += groupInfoElement;
  }

  // What to do on a get info failure.
  function onGetInfoFailure() {
    log("Failed to get group.")
  }

  // Called when a message is sent to the group.
  function onChatGroupMessage(message) {
    // Handle the message.
    var id = message.group_id;
    var messageText = message.message.text;
    var sender = message.sender.user_id;
    // Create the message element. Use Lodash to escape the message to prevent security issues.
    var element = "<div>" + sender + " (" + id + "): " + _.escape(messageText) + "</div>";

    // Add the message to the chat messages div.
    document.getElementById("chat-messages").innerHTML += element;
  }

  // Called when a user is added to a group.
  function onChatGroupInvite(message) {
    var id = message.group_id;
    var inviter = message.inviter;
    var invitees = message.invitees.join(", ");

    var element = "<div>" + invitees + " was added to group " + id + " by " + inviter + ".</div>";

    document.getElementById("chat-messages").innerHTML += element;
  }

  // Called when a user is removed from a group.
  function onChatGroupBoot(message) {
    var id = message.group_id;
    var booter = message.booter;
    var booted = message.booted.join(", ");

    var element = "<div>" + booted + " was removed from group " + id + " by " + booter + ".</div>";

    document.getElementById("chat-messages").innerHTML += element;
  }

  // Called when a group is updated.
  function onChatGroupUpdate(message) {
    var id = message.group_id;
    var updater = message.updater;
    var name = message.group_name;

    var element = "<div>Group " + id + " was updated by " + booter + " to " + name + ".</div>";

    document.getElementById("chat-messages").innerHTML += element;
  }

  // Called when a group is deleted.
  function onChatGroupDelete(message) {
    var id = message.group_id;
    var eraser = message.eraser;

    var element = "<div>Group " +   id + " was deleted by " + eraser + ".</div>";

    document.getElementById("chat-messages").innerHTML += element;
  }
  </script>
</body>
</html>
